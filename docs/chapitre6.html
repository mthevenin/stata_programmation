<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="fr" xml:lang="fr"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Programmation avec Stata - 6&nbsp; Manipulations des bases de données</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./chapitre7.html" rel="next">
<link href="./chapitre5.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "Pas de résultats",
    "search-matching-documents-text": "documents trouvés",
    "search-copy-link-title": "Copier le lien vers la recherche",
    "search-hide-matches-text": "Cacher les correspondances additionnelles",
    "search-more-match-text": "correspondance de plus dans ce document",
    "search-more-matches-text": "correspondances de plus dans ce document",
    "search-clear-button-title": "Effacer",
    "search-detached-cancel-button-title": "Annuler",
    "search-submit-button-title": "Envoyer",
    "search-label": "Recherche"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Programmation avec Stata</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Basculer la navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://mthevenin.github.io/stata_fr/index.html" rel="" target="">
 <span class="menu-text">Stata Ined</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://mthevenin.github.io/stata_fr/articles/" rel="" target="">
 <span class="menu-text">Articles</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-formations" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Formations</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-formations">    
        <li>
    <a class="dropdown-item" href="https://mthevenin.github.io/stata_programmation/" rel="" target="">
 <span class="dropdown-text">Formation initiale</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://mthevenin.github.io/stata_graphiques/" rel="" target="">
 <span class="dropdown-text">Graphiques</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <div class="quarto-navbar-tools ms-auto">
    <a href="https://github.com/mthevenin/stata_programmation" rel="" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="./stata_programmation.pdf" rel="" title="Download PDF" class="quarto-navigation-tool px-1" aria-label="Download PDF"><i class="bi bi-file-pdf"></i></a>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Basculer la barre latérale" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./chapitre6.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">**Manipulations des bases de données**</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Basculer la barre latérale" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation docked overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Recherche"></div>
        </div>
        </div>
        <div class="sidebar-tools-collapse">
    <a href="https://github.com/mthevenin" rel="" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
    <a href="mailto:marc.thevenin@ined.fr" rel="" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-envelope"></i></a>
</div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><strong>Présentation de la formation</strong></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapitre1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title"><strong>Présentation de Stata</strong></span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapitre2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title"><strong>L’environnement</strong></span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapitre3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title"><strong>Le langage Stata</strong></span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapitre4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title"><strong>Les bases de données</strong></span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapitre5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title"><strong>Les variables</strong></span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapitre6.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title"><strong>Manipulations des bases de données</strong></span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chapitre7.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Analyse statistique avec Stata</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Sections</h2>
   
  <ul>
  <li><a href="#fusion-de-bases" id="toc-fusion-de-bases" class="nav-link active" data-scroll-target="#fusion-de-bases"><span class="header-section-number">6.1</span> <strong>Fusion de bases</strong></a>
  <ul class="collapse">
  <li><a href="#append" id="toc-append" class="nav-link" data-scroll-target="#append"><span class="header-section-number">6.1.1</span> Append</a></li>
  <li><a href="#merge" id="toc-merge" class="nav-link" data-scroll-target="#merge"><span class="header-section-number">6.1.2</span> Merge</a></li>
  </ul></li>
  <li><a href="#transposition-dune-base" id="toc-transposition-dune-base" class="nav-link" data-scroll-target="#transposition-dune-base"><span class="header-section-number">6.2</span> <strong>Transposition d’une base</strong></a>
  <ul class="collapse">
  <li><a href="#syntaxe-et-exemples" id="toc-syntaxe-et-exemples" class="nav-link" data-scroll-target="#syntaxe-et-exemples"><span class="header-section-number">6.2.1</span> Syntaxe et exemples</a></li>
  <li><a href="#mise-en-garde" id="toc-mise-en-garde" class="nav-link" data-scroll-target="#mise-en-garde"><span class="header-section-number">6.2.2</span> Mise en garde</a></li>
  </ul></li>
  <li><a href="#allongement-dune-base" id="toc-allongement-dune-base" class="nav-link" data-scroll-target="#allongement-dune-base"><span class="header-section-number">6.3</span> Allongement d’une base</a></li>
  <li><a href="#créer-des-bases-dindicateurs" id="toc-créer-des-bases-dindicateurs" class="nav-link" data-scroll-target="#créer-des-bases-dindicateurs"><span class="header-section-number">6.4</span> Créer des bases d’indicateurs</a>
  <ul class="collapse">
  <li><a href="#collapse" id="toc-collapse" class="nav-link" data-scroll-target="#collapse"><span class="header-section-number">6.4.1</span> <code>collapse</code></a></li>
  <li><a href="#contract" id="toc-contract" class="nav-link" data-scroll-target="#contract"><span class="header-section-number">6.4.2</span> <code>contract</code></a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/mthevenin/stata_programmation/edit/main/chapitre6.qmd" class="toc-action">Modifier cette page</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title"><strong>Manipulations des bases de données</strong></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p><a href="https://mthevenin.github.io/stata_programmation/programme6.do"><strong>Programme du chapitre</strong></a></p>
<p><em>Commandes et expressions introduites</em></p>
<table class="table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th>SECTION</th>
<th>COMMANDES</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Fusion</strong></td>
<td><code>append</code> - <code>merge</code> - <code>frlink</code> - <code>ffrval</code></td>
</tr>
<tr class="even">
<td><strong>Transposition</strong></td>
<td><code>reshape long</code> <code>reshape wide</code></td>
</tr>
<tr class="odd">
<td><strong>Allongement</strong></td>
<td><code>expand</code></td>
</tr>
<tr class="even">
<td><strong>Base d’indicateurs</strong></td>
<td><code>collapse</code> <code>contract</code></td>
</tr>
</tbody>
</table>
<ul>
<li><strong>En gras, commandes externes</strong></li>
</ul>
<section id="fusion-de-bases" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="fusion-de-bases"><span class="header-section-number">6.1</span> <strong>Fusion de bases</strong></h2>
<ul>
<li>Deux types de fusions:
<ul>
<li>La fusion verticale non controlée - empilement - (<code>append</code>)</li>
<li>la fusion horizontale contrôlée - appariement - (<code>merge</code>).</li>
</ul></li>
</ul>
<section id="append" class="level3" data-number="6.1.1">
<h3 data-number="6.1.1" class="anchored" data-anchor-id="append"><span class="header-section-number">6.1.1</span> Append</h3>
<ul>
<li>Consiste simplement à ajouter des observations entre plusieurs bases, avec ou non un même jeu de variables.</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="img6/img1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="img6/img1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
<p>On va générer les deux bases de données avec la commande <code>input</code> (non traité dans cette formation: <code>help input</code>).</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">clear</span> </span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>input str6 id v1 v2</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"A"</span> 8 2 </span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"B"</span> 1 2 </span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"C"</span> 2 4</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="kw">save</span> base1, <span class="kw">replace</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<style>div.jp-Notebook .datagrid-container {min-height: 448px; }</style>
</div>
<div class="cell-output cell-output-stdout">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
     +--------------+
     | id   v1   v2 |
     |--------------|
  1. |  A    8    2 |
  2. |  B    1    2 |
  3. |  C    2    4 |
     +--------------+
file base1.dta saved</code></pre>
</div>
</div>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">clear</span> </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>input str20 id v1 v2 v3</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"D"</span> 2 5 10</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"E"</span> 12 1 8 </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="kw">save</span> base2, <span class="kw">replace</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
     +-------------------+
     | id   v1   v2   v3 |
     |-------------------|
  1. |  D    2    5   10 |
  2. |  E   12    1    8 |
     +-------------------+
file base2.dta saved</code></pre>
</div>
</div>
<p>La syntaxe de la commande <code>append</code> consiste à ajouter une ou plusieurs bases à la base active avec l’argument <code>using</code>.</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">append</span> <span class="kw">using</span> base1</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">sort</span> id</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
     +-------------------+
     | id   v1   v2   v3 |
     |-------------------|
  1. |  A    8    2    . |
  2. |  B    1    2    . |
  3. |  C    2    4    . |
  4. |  D    2    5   10 |
  5. |  E   12    1    8 |
     +-------------------+</code></pre>
</div>
</div>
<p>On peut sélectionner les variables de la base qui sera empilée à la base active avec l’option <code>keep</code>.<br>
Dans l’exemple, si la base active est <em>base1</em>, on peut ne pas vouloir ajouter la variable <em>v3</em> seulement renseignée pour les observations de <em>base2</em>.</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> base1, <span class="kw">clear</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="kw">append</span> <span class="kw">using</span> base2, <span class="kw">keep</span>(id v1 v2)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span> </span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(variable id was str6, now str20 to accommodate using data's values)

     +--------------+
     | id   v1   v2 |
     |--------------|
  1. |  A    8    2 |
  2. |  B    1    2 |
  3. |  C    2    4 |
  4. |  D    2    5 |
  5. |  E   12    1 |
     +--------------+</code></pre>
</div>
</div>
<p>Si les informations précédentes étaient ventilées dans trois bases, une par variable <em>v</em>, et avec le même niveau d’observation (A,B,C,D,E dans les 3 bases), l’utilisation de <code>append</code> conduirait à une structure empilée non souhaitable avec une réplication des <em>id</em>.</p>
<p>Pour obtenir la base finale proprement appariée, il convient de faire une fusion horizontale contrôlée par une une clé d’identification.</p>
</section>
<section id="merge" class="level3" data-number="6.1.2">
<h3 data-number="6.1.2" class="anchored" data-anchor-id="merge"><span class="header-section-number">6.1.2</span> Merge</h3>
<p>Stata demande que les bases soient soit triées (<code>sort</code>) sur la clé d’appariement en amont de l’opération. Sinon un message d’erreur sera renvoyé.</p>
<ul>
<li>La base active (ouverte) est appelée <strong>base master</strong></li>
<li>La base qui sera appariée à la base ouverte est appelée base <strong>using</strong> <a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></li>
</ul>
<p><strong>Syntaxe minimale 1 avec préfixes</strong>:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>merge <span class="co">[</span><span class="ot">1:1</span><span class="co">] [1:m]</span> <span class="co">[</span><span class="ot">m:1</span><span class="co">]</span> id_variables(s) using nom_base</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Ici on peut apparier plus de deux bases.</li>
<li>On dispose d’une sécurité si les niveaux d’identification sont différents.</li>
</ul>
<section id="même-niveau-didentification" class="level4" data-number="6.1.2.1">
<h4 data-number="6.1.2.1" class="anchored" data-anchor-id="même-niveau-didentification"><span class="header-section-number">6.1.2.1</span> Même niveau d’identification</h4>
<p>Partons des informations suivantes: - <em>Base1</em> comprend la variable d’identification <em>id</em> (observations A,B,C) et de deux variables numériques <em>v1</em> et <em>v3</em> - <em>Base2</em> comprend la même variable d’identification <em>id</em> (observations B,C,D) et de la variable numérique <em>v3</em></p>
<p><a href="img6/img3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="img6/img3.png" class="img-fluid"></a> Le niveau d’identification est identique dans les deux bases. Il s’agit donc d’un <strong><code>merge 1:1</code></strong> [<strong>One to One</strong>]</p>
<p>On va de nouveau générer les bases avec <code>input</code>.</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">clear</span> </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>input str1 id v1 v2 </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="st">"A"</span> 8 2 </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="st">"B"</span> 1 2</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="st">"C"</span> 2 4 </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="kw">sort</span> id</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="kw">save</span> base1, <span class="kw">replace</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
     +--------------+
     | id   v1   v2 |
     |--------------|
  1. |  A    8    2 |
  2. |  B    1    2 |
  3. |  C    2    4 |
     +--------------+
file base1.dta saved</code></pre>
</div>
</div>
<p>Rappel: bien faire le <code>sort</code> sur la base using</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">clear</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>input str1 id v3 </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="st">"B"</span> 10 </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="st">"C"</span> 8</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="st">"D"</span> 10 </span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="kw">sort</span> id</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="kw">save</span> base2, <span class="kw">replace</span> </span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
     +---------+
     | id   v3 |
     |---------|
  1. |  B   10 |
  2. |  C    8 |
  3. |  D   10 |
     +---------+
file base2.dta saved</code></pre>
</div>
</div>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">merge</span> 1:1 id <span class="kw">using</span> base1</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Result                      Number of obs
    -----------------------------------------
    Not matched                             2
        from master                         1  (_merge==1)
        from using                          1  (_merge==2)

    Matched                                 2  (_merge==3)
    -----------------------------------------</code></pre>
</div>
</div>
<ul>
<li><p>L’output affiche le résultat de l’appariement à l’aide d’un t ltrer si nécessaire les observations selon le résultat de l’apariement. Contrairement à d’autres applications, cette opération n’est pas effectuée en amont avec des fonctions où des options spécifiques. Par exemple avec R: <code>left_join</code>, <code>right_join</code>, <code>inner_join</code>. <code>_merge = 1</code> : observations qui se trouvent seulement dans la base active (master) <code>_merge = 2</code> : observations qui se trouvent seulement dans la base using (appariée) <code>_merge = 3</code> : observations communes aux bases master et using.</p></li>
<li><p>Les variables de la base master/active sont positionnées en tête de colonnes.</p></li>
</ul>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">sort</span> id</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
     +-------------------------------------+
     | id   v3   v1   v2            _merge |
     |-------------------------------------|
  1. |  A    .    8    2    Using only (2) |
  2. |  B   10    1    2       Matched (3) |
  3. |  C    8    2    4       Matched (3) |
  4. |  D   10    .    .   Master only (1) |
     +-------------------------------------+</code></pre>
</div>
</div>
<p>Si on souhaite seulement conserver les observations communes aux deux bases (<code>_merge=3</code>):</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">keep</span> <span class="kw">if</span> <span class="dt">_merge</span>==3</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(2 observations deleted)

     +---------------------------------+
     | id   v3   v1   v2        _merge |
     |---------------------------------|
  1. |  B   10    1    2   Matched (3) |
  2. |  C    8    2    4   Matched (3) |
     +---------------------------------+</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Variable _merge et appariements successifs
</div>
</div>
<div class="callout-body-container callout-body">
<p>Pensez à supprimer la variable *_merge* si plusieurs opérations d’appariement sont effectués. La commande ne prévoit pas d’écraser la variable de la fusion précédente.</p>
</div>
</div>
<p><strong>Situation avec plus d’une base à apparier</strong></p>
<p>On ne peux pas utiliser la syntaxe avec préfixe (ici <code>merge 1:1</code>).</p>
<p>On va ajouter une nouvelle base qui sera appariée avec les deux premières, qui seront donc les deux bases de type <em>using</em>.</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">clear</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>input str1 id str3  v4 </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="st">"A"</span> <span class="st">"Non"</span> </span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="st">"B"</span> <span class="st">"Oui"</span> </span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="st">"C"</span> <span class="st">"Oui"</span> </span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span> </span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="kw">sort</span> id</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
     +----------+
     | id    v4 |
     |----------|
  1. |  A   Non |
  2. |  B   Oui |
  3. |  C   Oui |
     +----------+</code></pre>
</div>
</div>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">merge</span> id <span class="kw">using</span> base1 base2</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="kw">order</span> id v1 v2 v3 v4 _merge1 _merge2 <span class="dt">_merge</span> </span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(you are using old merge syntax; see [D] merge for new syntax)

     +------------------------------------------------------+
     | id   v1   v2   v3    v4   _merge1   _merge2   _merge |
     |------------------------------------------------------|
  1. |  A    8    2    .   Non         1         0        3 |
  2. |  B    1    2   10   Oui         1         1        3 |
  3. |  C    2    4    8   Oui         1         1        3 |
  4. |  D    .    .   10               0         1        2 |
     +------------------------------------------------------+</code></pre>
</div>
</div>
<p>On obtient maintenant 3 variables _merge:</p>
<ul>
<li>*_merge1<em>. Donne le résultat de l’appariement entre la nouvelle base et </em>base1*: 0 si seulement dans une seule des deux bases (D), 1 si dans les deux bases (A,B,C).</li>
<li>*_merge2<em>. Donne le résultat de l’appariement entre la nouvelle base et </em>base2*: 0 si seulement dans une seule des deux bases (A,D), 1 si dans les deux bases (B,C).</li>
<li>*_merge*. Résume rapidement le matching entre les bases: on retrouve au moins une fois les observations (A,B,C) dans l’un des deux appariement (_merge=3), on trouve une observation (D) qui ne se trouve que dans une base <em>using</em> (_D_merge=2).</li>
</ul>
<p>Si l’on souhaite conserver les observations communes aux trois bases, on peut sommer les valeurs de *_merge1* et *_merge2* et conserver les observations dont la valeurs de cette somme est égale au nombre d’appariements; ou faire une sélection des observations avec un filtre conditionnel, ici:</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">keep</span> <span class="kw">if</span> _merge1==1 &amp; _merge2==1</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="kw">drop</span> <span class="dt">_merge</span>*</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(2 observations deleted)

     +------------------------------------------------------+
     | id   v1   v2   v3    v4   _merge1   _merge2   _merge |
     |------------------------------------------------------|
  1. |  B    1    2   10   Oui         1         1        3 |
  2. |  C    2    4    8   Oui         1         1        3 |
     +------------------------------------------------------+</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Commande join du package ftools
</div>
</div>
<div class="callout-body-container callout-body">
<p>[A tester]</p>
<ul>
<li><a href="https://github.com/sergiocorreia/ftools">Documentation</a>.</li>
<li>Permet de gagner 70% de durée d’exécution lorsque la volumétrie dépasse 100000 observations</li>
<li>Gère en amont le tri des bases appariée.</li>
</ul>
</div>
</div>
</section>
<section id="niveaux-didentification-différents" class="level4" data-number="6.1.2.2">
<h4 data-number="6.1.2.2" class="anchored" data-anchor-id="niveaux-didentification-différents"><span class="header-section-number">6.1.2.2</span> Niveaux d’identification différents</h4>
<p>Un merge de type 1:1 n’est pas possible. Dans l’exemple qui suit la base <em>period_act</em> liste pour deux personnes le statut d’activité observé pour plusieurs périodes soit des observations multiples pour chaque individus, et la base <em>sexe</em> donne une caractéristique unique pour chaque individu. Selon le statut des bases appariée (master ou using), l’appariement est de type 1:m ou m:1.</p>
<ul>
<li>Si la base active est à observations multiples sur la clé d’identification: m:1</li>
<li>Si la base active est à observations uniques sur la clé d’identification: 1:m</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="img6/img2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="img6/img2.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
<p>On va de nouveau générer les données avec <code>input</code></p>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">clear</span> </span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>input id périodes str8 Activité</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>1 1 <span class="st">"Emploi"</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>1 2 <span class="st">"Emploi"</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>1 3 <span class="st">"Chômage"</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>2 1 <span class="st">"Chômage"</span> </span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>2 2 <span class="st">"Chômage"</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>2 3 <span class="st">"Emploi"</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>2 4 <span class="st">"Chômage"</span> </span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span> </span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span> </span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="kw">sort</span> id </span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="kw">save</span> <span class="st">"period_act"</span>, <span class="kw">replace</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
     +--------------------------+
     | id   périodes   Activité |
     |--------------------------|
  1. |  1          1     Emploi |
  2. |  1          2     Emploi |
  3. |  1          3    Chômage |
  4. |  2          1    Chômage |
  5. |  2          2    Chômage |
     |--------------------------|
  6. |  2          3     Emploi |
  7. |  2          4    Chômage |
     +--------------------------+
file period_act.dta saved</code></pre>
</div>
</div>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">clear</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>input id str6 sexe </span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>1 <span class="st">"Homme"</span>  </span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>2 <span class="st">"Femme"</span>  </span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span> </span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="kw">sort</span> id </span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="kw">save</span> <span class="st">"sexe"</span>, <span class="kw">replace</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
     +------------+
     | id    sexe |
     |------------|
  1. |  1   Homme |
  2. |  2   Femme |
     +------------+
file sexe.dta saved</code></pre>
</div>
</div>
<p>Si on effectuait un merge 1:1, Stata renverrait le message d’erreur suivant:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>merge 1:1 id using activités</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>variable id does not uniquely identify observations in the using data</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>r(459);</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Ici la base active est la base <em>sex</em>. Le prefixe qui doit être utilisé est donc <strong><code>1:m</code></strong> <a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">merge</span> 1:<span class="fu">m</span> id <span class="kw">using</span> period_act</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="kw">sort</span> id période</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span> </span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                                 7  (_merge==3)
    -----------------------------------------

     +------------------------------------------------+
     | id    sexe   périodes   Activité        _merge |
     |------------------------------------------------|
  1. |  1   Homme          1     Emploi   Matched (3) |
  2. |  1   Homme          2     Emploi   Matched (3) |
  3. |  1   Homme          3    Chômage   Matched (3) |
  4. |  2   Femme          1    Chômage   Matched (3) |
  5. |  2   Femme          2    Chômage   Matched (3) |
     |------------------------------------------------|
  6. |  2   Femme          3     Emploi   Matched (3) |
  7. |  2   Femme          4    Chômage   Matched (3) |
     +------------------------------------------------+</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Astuce
</div>
</div>
<div class="callout-body-container callout-body">
<p>Le tri de la base est régulièrement modifié après ce type d’appariement. Penser donc à retrier les données proprement, surtout quand il s’agit comme ici d’informations biographiques (<code>sort id périodes</code>)</p>
</div>
</div>
<p>De nouveau les préfixes sont optionnels, et permettent seulement de contrôler l’appariement. On peut sans soucis fusionner des informations contextuelles avec des informations multiples avec seulement <code>merge</code>. Un avertissement se renvoyé à l’exécution de la commande</p>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> sexe, <span class="kw">clear</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="kw">merge</span> id <span class="kw">using</span> period_act</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="kw">sort</span> id périodes</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(you are using old merge syntax; see [D] merge for new syntax)
variable id does not uniquely identify observations in period_act.dta

     +-------------------------------------------+
     | id    sexe   périodes   Activité   _merge |
     |-------------------------------------------|
  1. |  1   Homme          1     Emploi        3 |
  2. |  1   Homme          2     Emploi        3 |
  3. |  1   Homme          3    Chômage        3 |
  4. |  2   Femme          1    Chômage        3 |
  5. |  2   Femme          2    Chômage        3 |
     |-------------------------------------------|
  6. |  2   Femme          3     Emploi        3 |
  7. |  2   Femme          4    Chômage        3 |
     +-------------------------------------------+</code></pre>
</div>
</div>
</section>
<section id="appariement-avec-des-frames" class="level4" data-number="6.1.2.3">
<h4 data-number="6.1.2.3" class="anchored" data-anchor-id="appariement-avec-des-frames"><span class="header-section-number">6.1.2.3</span> Appariement avec des frames</h4>
<p>L’utilisation des frames présentent plusieurs avantages:</p>
<ul>
<li>Il n’est pas nécessaire de trier les bases concernées par l’appariement.</li>
<li>On peut sélectionner avec la commande <code>frget</code> la ou les variables qui seront récupérées dans la base master. On apparie donc pas des bases en tant que telles, on récupère de l’information de frames liées.</li>
<li>Mieux encore, on peut réaliser des opérations entre observations individuelles et observations contextuelles sans passer par un appariement. Avec les frames, l’opération d’appariement doit être plutôt compris comme un système de liaison entre bases, le transfert d’informations n’étant qu’une opération optionnelle.</li>
</ul>
<p>Au niveau des désavantages:</p>
<ul>
<li>Si on ne travaille pas exclusivement sous frames, les bases devront être transformées en frame (voir exemple)</li>
<li>Absence de variable de type *_merge* qui permet de contrôler le résultat de l’appariement.</li>
<li>les prefixes sont uniquement 1:1 et m:1. Cela signifie dans le second cas que la frame active lors de l’opération de liaison doit toujours être celle dont la clé d’identification est de type multiple (niveau individuel).</li>
<li>Peut-être le plus embêtant est l’absence d’appariement pour les informations correspondant à **_merge=2** (Informations seulement présentes dans la base using). Le dernier exemple illustre ce point.</li>
</ul>
<p>On reprend l’exemple précédent, en transformant dans un premier temps les deux bases en frames.</p>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>frame <span class="kw">reset</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>frame create period_act</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>frame period_act: <span class="kw">use</span> period_act</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>frame create sexe</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>frame sexe: <span class="kw">use</span> sexe</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>frame <span class="ot">dir</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  default     0 x 0
  period_act  7 x 3; period_act.dta
  sexe        2 x 2; sexe.dta</code></pre>
</div>
</div>
<p>On doit se positionner sur la frame <em>period_act</em> (type m)</p>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>frame change period_act</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Pour lier les frames on utilise la commande <code>frlink</code>.</p>
<p><strong>Syntaxe</strong></p>
<div class="sourceCode" id="cb45"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>frlink 1:1/m:1 id_variable(s), frame(nom_frame) gen(variable_lien)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Ici on fait un appariement de type m:1, la clé d’identification est de nouveau <em>id</em>. On lie la frame active à la frame <em>sexe</em> et la variable de liaison (ici un alias de la variable id) est appelée <em>link</em>.</p>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>frlink <span class="fu">m</span>:1 id, frame(sexe) <span class="kw">gen</span>(<span class="kw">link</span>)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(all observations in frame period_act matched)</code></pre>
</div>
</div>
<p>Pour importer la variable sexe dans la frame <em>period_act</em>, on utilise la commande <strong><code>frget</code></strong>, en précisant la ou les variable que l’on souhaite récupérer, ainsi que la variable de liaison (une même frame peut avoir plusieurs liaisons. Voir plus loin).</p>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>frget sexe , from(<span class="kw">link</span>)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>frame period_act: <span class="kw">order</span> <span class="kw">link</span>, <span class="fu">last</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(1 variable copied from linked frame)

     +-----------------------------------------+
     | id   périodes   Activité    sexe   link |
     |-----------------------------------------|
  1. |  1          1     Emploi   Homme      1 |
  2. |  1          2     Emploi   Homme      1 |
  3. |  1          3    Chômage   Homme      1 |
  4. |  2          1    Chômage   Femme      2 |
  5. |  2          2    Chômage   Femme      2 |
     |-----------------------------------------|
  6. |  2          3     Emploi   Femme      2 |
  7. |  2          4    Chômage   Femme      2 |
     +-----------------------------------------+</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Liaison des frames en présence d’information incomplète
</div>
</div>
<div class="callout-body-container callout-body">
<p>La liaison de frames peut être problématique en présence d’informations incomplètes. Pour faire simple, la liaison des frames permet de faire des appariements de type **_merge=1** et **_merge=3** (présence dans la master seulement ou présence dans la master et la using) mais ne permet pas de récupérer des informations présentes seulement dans la base using).</p>
<p>Pour illustrer cela on va générer une nouvelle frame, de type individus-périodes, avec une variable additionnelle <em>tvc</em>.</p>
<ul>
<li>Pour id= 1, on a pas d’information dans la frame <em>period_act</em> pour période=4.</li>
<li>Pour id= 2, on a pas d’information dans la frame <em>tvc</em> pour les périodes 3 et 4.</li>
</ul>
<p>Création de la nouvelle frame (voir le .do, la compilation pour générer ce support complexifie un peu l’opération):</p>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>frame create tvc</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>frame change tvc</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="kw">clear</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>input id périodes tvc </span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>1 1 0   </span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>1 2 0   </span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>1 3 1  </span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>1 4 0  </span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>2 1 1  </span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>2 2 0 </span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span> </span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a><span class="kw">save</span> tvc, <span class="kw">replace</span></span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>frame tvc: <span class="kw">use</span> tvc</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
     +---------------------+
     | id   périodes   tvc |
     |---------------------|
  1. |  1          1     0 |
  2. |  1          2     0 |
  3. |  1          3     1 |
  4. |  1          4     0 |
  5. |  2          1     1 |
     |---------------------|
  6. |  2          2     0 |
     +---------------------+
file tvc.dta saved</code></pre>
</div>
</div>
<p>Liaison des frames et récupération de la variable tvc dans <em>period_act</em></p>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>frame change period_act</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>frlink 1:1 id périodes, frame(tvc) <span class="kw">gen</span>(link2)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>frget tvc, from(link2)</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(2 observations in frame period_act unmatched)
(2 missing values generated)
(1 variable copied from linked frame)

     +-------------------------------------------------------+
     | id   périodes   Activité    sexe   link   link2   tvc |
     |-------------------------------------------------------|
  1. |  1          1     Emploi   Homme      1       1     0 |
  2. |  1          2     Emploi   Homme      1       2     0 |
  3. |  1          3    Chômage   Homme      1       3     1 |
  4. |  2          1    Chômage   Femme      2       5     1 |
  5. |  2          2    Chômage   Femme      2       6     0 |
     |-------------------------------------------------------|
  6. |  2          3     Emploi   Femme      2       .     . |
  7. |  2          4    Chômage   Femme      2       .     . |
     +-------------------------------------------------------+</code></pre>
</div>
</div>
<p>On voit bien que la valeur de tvc pour id=1 et périodes=4 n’a pas été importée (**_merge=2** dans un appariement classique). En revanche, pour id=2, l’incomplétude de l’information dans la base <em>tvc</em> pour les périodes 3 et 4 est bien visible.</p>
<p>Avec un merge classique (on suppose que <em>period_act</em> n’a pas été appariée à <em>sexe</em>):</p>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> tvc, <span class="kw">clear</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="kw">sort</span> id périodes</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="kw">save</span> tvc, <span class="kw">replace</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> period_act, <span class="kw">clear</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="kw">sort</span> id périodes</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a><span class="kw">merge</span> 1:1 id périodes <span class="kw">using</span> tvc</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a><span class="kw">sort</span> id périodes</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>file tvc.dta saved

    Result                      Number of obs
    -----------------------------------------
    Not matched                             3
        from master                         2  (_merge==1)
        from using                          1  (_merge==2)

    Matched                                 5  (_merge==3)
    -----------------------------------------

     +--------------------------------------------------+
     | id   périodes   Activité   tvc            _merge |
     |--------------------------------------------------|
  1. |  1          1     Emploi     0       Matched (3) |
  2. |  1          2     Emploi     0       Matched (3) |
  3. |  1          3    Chômage     1       Matched (3) |
  4. |  1          4                0    Using only (2) |
  5. |  2          1    Chômage     1       Matched (3) |
     |--------------------------------------------------|
  6. |  2          2    Chômage     0       Matched (3) |
  7. |  2          3     Emploi     .   Master only (1) |
  8. |  2          4    Chômage     .   Master only (1) |
     +--------------------------------------------------+</code></pre>
</div>
</div>
<p>On a bien ici l’ajout de l’information correspondant à _merge=2 (<em>Using only</em>)</p>
</div>
</div>
<p>Un des intérêts des frames, est de faire des opérations entre informations individuelles et contextuelles sans passer par un appariement en amont. Par l’exemple, nous allons voir comment un appariement peut être évité lorsqu’on travaille sur ce genre d’information.</p>
<p>On va générer 2 bases, une individuelle et une contextuelle. La première contient un identifiant individuel (<em>id</em>), le nom de la zône d’appartenance (<em>zone</em>) et les valeurs observées d’une variable <em>x</em>. La seconde contient le nom des zônes et la valeur moyenne de la variable x dans ces espaces.</p>
<p>Création des frames:</p>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>frame <span class="kw">reset</span> </span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="kw">clear</span> </span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>input id str6 zone x</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>1 <span class="st">"zoneA"</span> 10</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>2 <span class="st">"zoneA"</span> 15</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>3 <span class="st">"zoneB"</span> 9</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>4 <span class="st">"zoneB"</span> 12</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>5 <span class="st">"zoneB"</span> 10</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>6 <span class="st">"zoneB"</span> 15</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>7 <span class="st">"zoneC"</span> 6</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>8 <span class="st">"zoneC"</span> 13</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>9 <span class="st">"zoneC"</span> 16</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a><span class="kw">save</span> indiv, <span class="kw">replace</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
     +-----------------+
     | id    zone    x |
     |-----------------|
  1. |  1   zoneA   10 |
  2. |  2   zoneA   15 |
  3. |  3   zoneB    9 |
  4. |  4   zoneB   12 |
  5. |  5   zoneB   10 |
     |-----------------|
  6. |  6   zoneB   15 |
  7. |  7   zoneC    6 |
  8. |  8   zoneC   13 |
  9. |  9   zoneC   16 |
     +-----------------+
file indiv.dta saved</code></pre>
</div>
</div>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="kw">clear</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>input str6 zone xmean</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="st">"zoneA"</span> 11</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="st">"zoneB"</span> 12</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="st">"zoneC"</span> 13</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a><span class="kw">save</span> zone, <span class="kw">replace</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
     +---------------+
     |  zone   xmean |
     |---------------|
  1. | zoneA      11 |
  2. | zoneB      12 |
  3. | zoneC      13 |
     +---------------+
file zone.dta saved</code></pre>
</div>
</div>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>frame create indiv</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>frame indiv: <span class="kw">use</span> indiv</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>frame create zone</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>frame zone: <span class="kw">use</span> zone</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Après avoir lié les deux frames (m:1), on va calculer directement la différence entre la valeur observée pour chaque individu de la variable <em>x</em> et sa moyenne par zone (<em>xmean</em>). On utilise la fonction <strong><code>frval</code></strong> comme argument de la commande <strong><code>generate</code></strong>.</p>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>frame change indiv</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>frlink <span class="fu">m</span>:1 zone, frame(zone) <span class="kw">gen</span>(<span class="kw">link</span>)</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(all observations in frame indiv matched)

     +------------------------+
     | id    zone    x   link |
     |------------------------|
  1. |  1   zoneA   10      1 |
  2. |  2   zoneA   15      1 |
  3. |  3   zoneB    9      2 |
  4. |  4   zoneB   12      2 |
  5. |  5   zoneB   10      2 |
     |------------------------|
  6. |  6   zoneB   15      2 |
  7. |  7   zoneC    6      3 |
  8. |  8   zoneC   13      3 |
  9. |  9   zoneC   16      3 |
     +------------------------+</code></pre>
</div>
</div>
<div class="sourceCode" id="cb66"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>gen = var1 - frval(nom_link, var2)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="kw">gen</span> diffx = x - frval(<span class="kw">link</span>, xmean)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
     +--------------------------------+
     | id    zone    x   link   diffx |
     |--------------------------------|
  1. |  1   zoneA   10      1      -1 |
  2. |  2   zoneA   15      1       4 |
  3. |  3   zoneB    9      2      -3 |
  4. |  4   zoneB   12      2       0 |
  5. |  5   zoneB   10      2      -2 |
     |--------------------------------|
  6. |  6   zoneB   15      2       3 |
  7. |  7   zoneC    6      3      -7 |
  8. |  8   zoneC   13      3       0 |
  9. |  9   zoneC   16      3       3 |
     +--------------------------------+</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="transposition-dune-base" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="transposition-dune-base"><span class="header-section-number">6.2</span> <strong>Transposition d’une base</strong></h2>
<section id="syntaxe-et-exemples" class="level3" data-number="6.2.1">
<h3 data-number="6.2.1" class="anchored" data-anchor-id="syntaxe-et-exemples"><span class="header-section-number">6.2.1</span> Syntaxe et exemples</h3>
<p>Cette opération permet d’<strong>allonger</strong> ou d’<strong>élargir</strong> une base, généralement sur des variables occurencées. Ces occurences peuvent être des séquences ou points chronologiques (valeur d’une variable sur plusieurs années), ou des individus composant un ménage.</p>
<p>Avec Stata, ces opérations de transpositions sont effectuées avec la commande <strong><code>reshape</code></strong></p>
<ul>
<li>De large à long: <strong><code>reshape long</code></strong></li>
<li>De long à large: <strong><code>reshape wide</code></strong></li>
</ul>
<p>A noter que la seconde opération est plus gourmande en durée d’exécution. De nouveau si la volumétrie de la base est élevée, disons plus d’une million d’observations, on peut se reporter sur la commande <strong><code>greshape</code></strong> du package <strong><code>gtools</code></strong>. On peut trouver un benchmark sur des données simulées [<a href="https://mthevenin.github.io/stata_fr/articles/index/posts/gtools/gtools.html">liens</a>].</p>
<p>Au niveau de la syntaxe:</p>
<ul>
<li>Il est nécessaire d’avoir une variable d’identification pour réaliser l’opération: cela peut être un identifiant individuel<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> si la variations des observations est relatives à des périodes, ou un identifiant ménage si la source de la variation sont les personnes le composant. Ce peut bien évidemment fonctionner avec des zônes géographiques: régions-départements, régions-communes, départements-communes.<br>
Cette variable d’identification doit être renseignée en option: <strong><code>i(var_id)</code></strong></li>
<li>On indique dans l’expression principale le racine des variables occurencées: si la base est en format large avec les variables <em>revenu1980</em>, <em>revenu1981</em>,….,<em>revenu1990</em>, la racine sera donc <strong>revenu</strong>. Les occurences peuvent être des lettres (A,B,D…) ou des mots (un,deux,trois…).</li>
<li>Information sur les occurences: selon le type de transposition on doit indiquer en option la variable qui contiendra ou qui contient les occurences. Cette option est <strong><code>j(nom_variable)</code></strong>
<ul>
<li>si la base est en format large et qu’on souhaite l’allonger, on indique obligatoirement la variable qui sera créée et qui reportera les valeurs des occurences.</li>
<li>si la base est en format long et qu’on souhaite l’élargir, on indique obligatoirement la variable qui contient les occurences.</li>
</ul></li>
<li>Selon la transposition, le nom de commande est suivi de <strong><code>long</code></strong> ou <strong><code>wide</code></strong></li>
</ul>
<p><strong>Syntaxe de large à long</strong>:</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>reshape long racines_variables_occurencées, i(var_id) j(var_occurences)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Syntaxe de long à large</strong>:</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>reshape wide racines_variables_occurencées, i(var_id) j(var_occurences)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Exemple</strong></p>
<p>On part de la base suivante</p>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="kw">clear</span> </span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>input id x1 <span class="kw">x2</span> x3 x4</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>1 10 20 12 25</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>2 12 22 15 30</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>3 15 25 33 30</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>4 21 17 22 27</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>5 13 15 14 18</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
     +------------------------+
     | id   x1   x2   x3   x4 |
     |------------------------|
  1. |  1   10   20   12   25 |
  2. |  2   12   22   15   30 |
  3. |  3   15   25   33   30 |
  4. |  4   21   17   22   27 |
  5. |  5   13   15   14   18 |
     +------------------------+</code></pre>
</div>
</div>
<p>On allonger la base sur les variables <em>x1</em> à <em>x4</em>. La racine est donc <em>x</em>. Pour le choix de la nouvelle variable qui aura pour chaque id les valeurs 1 à 4, on ne peux pas choisir x, qui sera créée automatiquement. Selon le type d’information contenu dans l’occurence, on peut utiliser un nom indiquant une période, un membre de ménage ou une zône géographique. Ici on ca suposer que les occurences sont de nature temporelle, et on choisira <em>t</em> comme nom à la variable de l’option <code>j()</code>.</p>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="kw">reshape</span> <span class="kw">long</span> x , i(id) j(t)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(j = 1 2 3 4)

Data                               Wide   -&gt;   Long
-----------------------------------------------------------------------------
Number of observations                5   -&gt;   20          
Number of variables                   5   -&gt;   3           
j variable (4 values)                     -&gt;   t
xij variables:
                           x1 x2 ... x4   -&gt;   x
-----------------------------------------------------------------------------</code></pre>
</div>
</div>
<p>On remarque que Stata donne quelques informations sur le résultats de l’opération: variables créées, nombre d’observations dans le nouveau format</p>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
     +-------------+
     | id   t    x |
     |-------------|
  1. |  1   1   10 |
  2. |  1   2   20 |
  3. |  1   3   12 |
  4. |  1   4   25 |
  5. |  2   1   12 |
     |-------------|
  6. |  2   2   22 |
  7. |  2   3   15 |
  8. |  2   4   30 |
  9. |  3   1   15 |
 10. |  3   2   25 |
     |-------------|
 11. |  3   3   33 |
 12. |  3   4   30 |
 13. |  4   1   21 |
 14. |  4   2   17 |
 15. |  4   3   22 |
     |-------------|
 16. |  4   4   27 |
 17. |  5   1   13 |
 18. |  5   2   15 |
 19. |  5   3   14 |
 20. |  5   4   18 |
     +-------------+</code></pre>
</div>
</div>
<p>On peut repasser au format de départ (large) avec <code>reshape wide</code></p>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="kw">reshape</span> <span class="kw">wide</span> x , i(id) j(t)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(j = 1 2 3 4)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Data                               Long   -&gt;   Wide
-----------------------------------------------------------------------------
Number of observations               20   -&gt;   5           
Number of variables                   3   -&gt;   5           
j variable (4 values)                 t   -&gt;   (dropped)
xij variables:
                                      x   -&gt;   x1 x2 ... x4
-----------------------------------------------------------------------------</code></pre>
</div>
</div>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
     +------------------------+
     | id   x1   x2   x3   x4 |
     |------------------------|
  1. |  1   10   20   12   25 |
  2. |  2   12   22   15   30 |
  3. |  3   15   25   33   30 |
  4. |  4   21   17   22   27 |
  5. |  5   13   15   14   18 |
     +------------------------+</code></pre>
</div>
</div>
<p>Bien évidemment les variable fixes ne doivent pas être renseigné dans la commande, les valeurs sont conservées</p>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="kw">clear</span> </span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>input id x1 <span class="kw">x2</span> x3 x4 fixe</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>1 10 20 12 25 0</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>2 12 22 15 30 1</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>3 15 25 33 30 0</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>4 21 17 22 27 1</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>5 13 15 14 18 0</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a><span class="kw">reshape</span> <span class="kw">long</span> x, i(id) j(t)</span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
     +-------------------------------+
     | id   x1   x2   x3   x4   fixe |
     |-------------------------------|
  1. |  1   10   20   12   25      0 |
  2. |  2   12   22   15   30      1 |
  3. |  3   15   25   33   30      0 |
  4. |  4   21   17   22   27      1 |
  5. |  5   13   15   14   18      0 |
     +-------------------------------+
(j = 1 2 3 4)

Data                               Wide   -&gt;   Long
-----------------------------------------------------------------------------
Number of observations                5   -&gt;   20          
Number of variables                   6   -&gt;   4           
j variable (4 values)                     -&gt;   t
xij variables:
                           x1 x2 ... x4   -&gt;   x
-----------------------------------------------------------------------------

     +--------------------+
     | id   t    x   fixe |
     |--------------------|
  1. |  1   1   10      0 |
  2. |  1   2   20      0 |
  3. |  1   3   12      0 |
  4. |  1   4   25      0 |
  5. |  2   1   12      1 |
     |--------------------|
  6. |  2   2   22      1 |
  7. |  2   3   15      1 |
  8. |  2   4   30      1 |
  9. |  3   1   15      0 |
 10. |  3   2   25      0 |
     |--------------------|
 11. |  3   3   33      0 |
 12. |  3   4   30      0 |
 13. |  4   1   21      1 |
 14. |  4   2   17      1 |
 15. |  4   3   22      1 |
     |--------------------|
 16. |  4   4   27      1 |
 17. |  5   1   13      0 |
 18. |  5   2   15      0 |
 19. |  5   3   14      0 |
 20. |  5   4   18      0 |
     +--------------------+</code></pre>
</div>
</div>
</section>
<section id="mise-en-garde" class="level3" data-number="6.2.2">
<h3 data-number="6.2.2" class="anchored" data-anchor-id="mise-en-garde"><span class="header-section-number">6.2.2</span> Mise en garde</h3>
<p><strong>Complétude du nom de la racine</strong></p>
<p>Bien penser à mettre l’intégralité de la racine, partie fixe de la variable occurencée:</p>
<div class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="kw">clear</span> </span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>input id x_1 x_2 x_3 x_4</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>1 10 20 12 25</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>2 12 22 15 30</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>3 15 25 33 30</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>4 21 17 22 27</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>5 13 15 14 18</span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
     +----------------------------+
     | id   x_1   x_2   x_3   x_4 |
     |----------------------------|
  1. |  1    10    20    12    25 |
  2. |  2    12    22    15    30 |
  3. |  3    15    25    33    30 |
  4. |  4    21    17    22    27 |
  5. |  5    13    15    14    18 |
     +----------------------------+</code></pre>
</div>
</div>
<div class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="kw">reshape</span> <span class="kw">long</span> x , i(id) j(t)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>renverra le message d’erreur suivant:</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>variable t contains all missing values</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>r(498);</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Omission de variables occurencée</strong></p>
<p>Contrairement à l’allongement, l’élargissement est plus contraignant, toutes les variables non fixes doivent être renseignées.</p>
<p>Si on omet des variables occurencées dans l’allongement, elle sont conservées tel quel et les valeurs sont répliquées d’une ligne à l’autre:</p>
<div class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="kw">clear</span> </span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>input id x1 <span class="kw">x2</span> y1 y2 fixe</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>1 10 20 12 25 0</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>2 12 22 15 30 0</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>3 15 25 33 30 1</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>4 21 17 22 27 1</span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>5 13 15 14 18 0</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a><span class="kw">reshape</span> <span class="kw">long</span> x , i(id) j(t)</span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
     +-------------------------------+
     | id   x1   x2   y1   y2   fixe |
     |-------------------------------|
  1. |  1   10   20   12   25      0 |
  2. |  2   12   22   15   30      0 |
  3. |  3   15   25   33   30      1 |
  4. |  4   21   17   22   27      1 |
  5. |  5   13   15   14   18      0 |
     +-------------------------------+
(j = 1 2)

Data                               Wide   -&gt;   Long
-----------------------------------------------------------------------------
Number of observations                5   -&gt;   10          
Number of variables                   6   -&gt;   6           
j variable (2 values)                     -&gt;   t
xij variables:
                                  x1 x2   -&gt;   x
-----------------------------------------------------------------------------

     +------------------------------+
     | id   t    x   y1   y2   fixe |
     |------------------------------|
  1. |  1   1   10   12   25      0 |
  2. |  1   2   20   12   25      0 |
  3. |  2   1   12   15   30      0 |
  4. |  2   2   22   15   30      0 |
  5. |  3   1   15   33   30      1 |
     |------------------------------|
  6. |  3   2   25   33   30      1 |
  7. |  4   1   21   22   27      1 |
  8. |  4   2   17   22   27      1 |
  9. |  5   1   13   14   18      0 |
 10. |  5   2   15   14   18      0 |
     +------------------------------+</code></pre>
</div>
</div>
<p>En revanche si on part d’une base longue avec plusieurs dimensions variables</p>
<div class="cell" data-execution_count="38">
<div class="cell-output cell-output-stdout">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>(j = 1 2)

Data                               Wide   -&gt;   Long
-----------------------------------------------------------------------------
Number of observations                5   -&gt;   10          
Number of variables                   6   -&gt;   5           
j variable (2 values)                     -&gt;   t
xij variables:
                                  x1 x2   -&gt;   x
                                  y1 y2   -&gt;   y
-----------------------------------------------------------------------------</code></pre>
</div>
</div>
<div class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
     +-------------------------+
     | id   t    x    y   fixe |
     |-------------------------|
  1. |  1   1   10   12      0 |
  2. |  1   2   20   25      0 |
  3. |  2   1   12   15      0 |
  4. |  2   2   22   30      0 |
  5. |  3   1   15   33      1 |
     |-------------------------|
  6. |  3   2   25   30      1 |
  7. |  4   1   21   22      1 |
  8. |  4   2   17   27      1 |
  9. |  5   1   13   14      0 |
 10. |  5   2   15   18      0 |
     +-------------------------+</code></pre>
</div>
</div>
<div class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="kw">reshape</span> <span class="kw">wide</span> x, i(id) j(t)</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>renverra le message d’erreur suivant:</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>(j = 1 2)</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>variable y not constant within id</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>Your data are currently long. You are performing a reshape wide. You typed something like</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>. reshape wide a b, i(id) j(t)</span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a><span class="in">    There are variables other than a, b, id, t in your data. They must be constant within id because that is the only way they can fit into wide data without loss</span></span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a><span class="in">    of information.</span></span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a><span class="in">    The variable or variables listed above are not constant within id. Perhaps the values are in error. Type reshape error for a list of the problem observations.</span></span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a><span class="in">    Either that, or the values vary because they should vary, in which case you must either add the variables to the list of xij variables to be reshaped, or drop them.</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="allongement-dune-base" class="level2" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="allongement-dune-base"><span class="header-section-number">6.3</span> Allongement d’une base</h2>
<p>Section très courte. Pariculièrement utile lorsqu’on manipule des données biographiques avec des durées, et pour faire la mise en forme nécessaire pour une analyse à durée discrète. La commande <em><code>expand</code></em> permet de répliquer les lignes, sur une valeur fixe qu’on indique ou sur des valeurs non constantes renseignés dans une variable.</p>
<p>Dans le premier cas la syntaxe est: <strong><code>expand valeur</code></strong> Dans le second cas la synataxe est: <strong><code>expand nom_variable</code></strong></p>
<p>Exemple:</p>
<div class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="kw">clear</span> </span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>input id duree <span class="fu">e</span></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>1  3 0 </span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>2  4 1</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>3  2 1 </span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
     +----------------+
     | id   duree   e |
     |----------------|
  1. |  1       3   0 |
  2. |  2       4   1 |
  3. |  3       2   1 |
     +----------------+</code></pre>
</div>
</div>
<p><strong><em>Allongement de la base</em>:</strong></p>
<div class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>expand duree</span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(6 observations created)</code></pre>
</div>
</div>
<p><strong><em>Si on veut faire une analyse à durée discrère, avec les variables de comptage (chapitre 5):</em></strong></p>
<div class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="kw">bysort</span> id: <span class="kw">gen</span> t=<span class="dt">_n</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="kw">bysort</span> id: <span class="kw">replace</span> <span class="fu">e</span>=0 <span class="kw">if</span> t&lt;_N</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(4 real changes made)

     +--------------------+
     | id   duree   e   t |
     |--------------------|
  1. |  1       3   0   1 |
  2. |  1       3   0   2 |
  3. |  1       3   0   3 |
  4. |  2       4   0   1 |
  5. |  2       4   0   2 |
     |--------------------|
  6. |  2       4   0   3 |
  7. |  2       4   1   4 |
  8. |  3       2   0   1 |
  9. |  3       2   1   2 |
     +--------------------+</code></pre>
</div>
</div>
<p>Remarque: si la valeur sur laquelle est allongée la base a une valeur négative (par exemple des durées négatives), un message indique leur présence.</p>
</section>
<section id="créer-des-bases-dindicateurs" class="level2" data-number="6.4">
<h2 data-number="6.4" class="anchored" data-anchor-id="créer-des-bases-dindicateurs"><span class="header-section-number">6.4</span> Créer des bases d’indicateurs</h2>
<p>Dans ce qui suit il est fortement recommandé d’utiliser les frames (Stata 16 minimum). Pour faire ce type d’opérations deux commandes sont disponibles:</p>
<ul>
<li>la plus utilisée, <strong><code>collapse</code></strong> permet de créer une base d’indicateurs dédiées aux variables quantitatives: moyenne, médiane et autes quantiles, ….</li>
<li>la moins utilisée, <strong><code>contract</code></strong>, est dédiée aux variables catégorielles (effectifs et effectif cumulés, proportions et proportions cumulées).</li>
</ul>
<p>Pour les pondérations admises, se reporter à l’aide des commandes<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Ecrasement de la base d’origine
</div>
</div>
<div class="callout-body-container callout-body">
<p>Attention la base sur laquelle on travaille va être écrasée. Si ce n’est pas souhaité:</p>
<ul>
<li><p>Utiliser les commandes <code>preserve</code> <code>restore</code> avant et après l’opération.</p></li>
<li><p>Générer une frame avec les variables qui seront transformées en indicateurs. On pourra conserver les deux bases dans la sessions, et les utiliser en parallèle.</p></li>
</ul>
</div>
</div>
<section id="collapse" class="level3" data-number="6.4.1">
<h3 data-number="6.4.1" class="anchored" data-anchor-id="collapse"><span class="header-section-number">6.4.1</span> <code>collapse</code></h3>
<p>Les indicateurs disponibles sont les suivants:</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="in">        mean         means (default)</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="in">        median       medians</span></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a><span class="in">        p1           1st percentile</span></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a><span class="in">        p2           2nd percentile</span></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a><span class="in">        ...          3rd-49th percentiles</span></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a><span class="in">        p50          50th percentile (same as median)</span></span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a><span class="in">        ...          51st-97th percentiles</span></span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a><span class="in">        p98          98th percentile</span></span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a><span class="in">        p99          99th percentile</span></span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a><span class="in">        sd           standard deviations</span></span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a><span class="in">        semean       standard error of the mean (sd/sqrt(n))</span></span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true" tabindex="-1"></a><span class="in">        sebinomial   standard error of the mean, binomial (sqrt(p(1-p)/n))</span></span>
<span id="cb107-13"><a href="#cb107-13" aria-hidden="true" tabindex="-1"></a><span class="in">        sepoisson    standard error of the mean, Poisson (sqrt(mean/n))</span></span>
<span id="cb107-14"><a href="#cb107-14" aria-hidden="true" tabindex="-1"></a><span class="in">        sum          sums</span></span>
<span id="cb107-15"><a href="#cb107-15" aria-hidden="true" tabindex="-1"></a><span class="in">        rawsum       sums, ignoring optionally specified weight except observations with a weight of zero are excluded</span></span>
<span id="cb107-16"><a href="#cb107-16" aria-hidden="true" tabindex="-1"></a><span class="in">        count        number of nonmissing observations</span></span>
<span id="cb107-17"><a href="#cb107-17" aria-hidden="true" tabindex="-1"></a><span class="in">        percent      percentage of nonmissing observations</span></span>
<span id="cb107-18"><a href="#cb107-18" aria-hidden="true" tabindex="-1"></a><span class="in">        max          maximums</span></span>
<span id="cb107-19"><a href="#cb107-19" aria-hidden="true" tabindex="-1"></a><span class="in">        min          minimums</span></span>
<span id="cb107-20"><a href="#cb107-20" aria-hidden="true" tabindex="-1"></a><span class="in">        iqr          interquartile range</span></span>
<span id="cb107-21"><a href="#cb107-21" aria-hidden="true" tabindex="-1"></a><span class="in">        first        first value</span></span>
<span id="cb107-22"><a href="#cb107-22" aria-hidden="true" tabindex="-1"></a><span class="in">        last         last value</span></span>
<span id="cb107-23"><a href="#cb107-23" aria-hidden="true" tabindex="-1"></a><span class="in">        firstnm      first nonmissing value</span></span>
<span id="cb107-24"><a href="#cb107-24" aria-hidden="true" tabindex="-1"></a><span class="in">        lastnm       last nonmissing value</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>Par défaut c’est la moyenne qui est utilisée.</li>
<li>Les résultats peuvent être stratifiées avec une option <code>by()</code>.</li>
</ul>
<p><strong>Syntaxe avec un seul indicateur</strong></p>
<div class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="kw">collapse</span> [(statistique autre que moyenne) <span class="kw">varlist</span> [, <span class="kw">by</span>(<span class="kw">varlist</span>)] </span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Dans les exemples, on utilisera <code>preserve</code> <code>restore</code> pour retrouver la base de départ.</p>
<p><strong><em>Exemples</em></strong></p>
<div class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="kw">clear</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="kw">sysuse</span> auto</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a><span class="kw">preserve</span> </span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a><span class="kw">collapse</span> price</span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a><span class="kw">restore</span></span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a><span class="kw">preserve</span> </span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a><span class="kw">collapse</span> price mpg, <span class="kw">by</span>(foreign)</span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true" tabindex="-1"></a><span class="kw">restore</span></span>
<span id="cb109-13"><a href="#cb109-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-14"><a href="#cb109-14" aria-hidden="true" tabindex="-1"></a><span class="kw">preserve</span> </span>
<span id="cb109-15"><a href="#cb109-15" aria-hidden="true" tabindex="-1"></a><span class="kw">collapse</span> (<span class="kw">median</span>) price mpg, <span class="kw">by</span>(foreign)</span>
<span id="cb109-16"><a href="#cb109-16" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span>
<span id="cb109-17"><a href="#cb109-17" aria-hidden="true" tabindex="-1"></a><span class="kw">restore</span></span>
<span id="cb109-18"><a href="#cb109-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-19"><a href="#cb109-19" aria-hidden="true" tabindex="-1"></a><span class="kw">preserve</span> </span>
<span id="cb109-20"><a href="#cb109-20" aria-hidden="true" tabindex="-1"></a><span class="kw">collapse</span> (<span class="kw">median</span>) price mpg <span class="kw">if</span> rep78!=., <span class="kw">by</span>(foreign rep78)</span>
<span id="cb109-21"><a href="#cb109-21" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span>
<span id="cb109-22"><a href="#cb109-22" aria-hidden="true" tabindex="-1"></a><span class="kw">restore</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Note: Below code run with echo to enable preserve/restore functionality.)

. clear

. sysuse auto
(1978 automobile data)

. preserve

. collapse price

. list

     +---------+
     |   price |
     |---------|
  1. | 6,165.3 |
     +---------+

. restore

. preserve

. collapse price mpg, by(foreign)

. list

     +------------------------------+
     |  foreign     price       mpg |
     |------------------------------|
  1. | Domestic   6,072.4   19.8269 |
  2. |  Foreign   6,384.7   24.7727 |
     +------------------------------+

. restore

. preserve

. collapse (median) price mpg, by(foreign)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
. list

     +---------------------------+
     |  foreign     price    mpg |
     |---------------------------|
  1. | Domestic   4,782.5     19 |
  2. |  Foreign     5,759   24.5 |
     +---------------------------+

. restore

. preserve

. collapse (median) price mpg if rep78!=., by(foreign rep78)

. list

     +----------------------------------+
     | rep78    foreign     price   mpg |
     |----------------------------------|
  1. |     1   Domestic   4,564.5    21 |
  2. |     2   Domestic     4,638    18 |
  3. |     3   Domestic     4,749    19 |
  4. |     4   Domestic     5,705    18 |
  5. |     5   Domestic   4,204.5    32 |
     |----------------------------------|
  6. |     3    Foreign     4,296    23 |
  7. |     4    Foreign     6,229    25 |
  8. |     5    Foreign     5,719    25 |
     +----------------------------------+

. restore

. </code></pre>
</div>
</div>
<p>On voit que la variable indicateur prend le nom de la variable. On ne peut donc pas générer une liste d’indicateurs sans renommer les variables.</p>
<p><strong>Syntaxe avec plusieurs indicateurs</strong></p>
<p>Dans l’expression principal, on doit donner un nom différent à chaque variable pour chaque indicateur…ce n’est pas très pratique, Stata aurait pu prévoir un moyen de générer par défaut des nom de variable comme mean_varname, min_varname….</p>
<p>Dans le cas de deux indicateurs (<em>median</em>, <em>min</em>) pour deux variable (<em>price</em>, <em>mpg</em>).</p>
<div class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="kw">collapse</span> [(stat1) varname11 = var1 varname21= var2  (stat2 ) varname12 = var1 varname22= var2 [, <span class="kw">by</span>(<span class="kw">varlist</span>)] </span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="kw">preserve</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="kw">collapse</span> (<span class="kw">median</span>) pricemed = price mpgmed=mpg  (<span class="fu">min</span>) pricemin = price mpgmin= mpg , <span class="kw">by</span>(foreign)</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a><span class="kw">restore</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Note: Below code run with echo to enable preserve/restore functionality.)

. preserve

. collapse (median) pricemed = price mpgmed=mpg (min) pricemin = price mpgmin= 
&gt; mpg , by(foreign)

. list

     +--------------------------------------------------+
     |  foreign   pricemed   mpgmed   pricemin   mpgmin |
     |--------------------------------------------------|
  1. | Domestic    4,782.5       19      3,291       12 |
  2. |  Foreign      5,759     24.5      3,748       14 |
     +--------------------------------------------------+

. restore

. </code></pre>
</div>
</div>
<p>Remarque: pour des variables codées sous forme d’indicatrice, on peut générer des proportions ou des pourcentages facilement, ce qui rend la commande <code>contract</code> caduque avec deux modalités (exemple: variable foreign).</p>
</section>
<section id="contract" class="level3" data-number="6.4.2">
<h3 data-number="6.4.2" class="anchored" data-anchor-id="contract"><span class="header-section-number">6.4.2</span> <code>contract</code></h3>
<p>Même principe, mais le nombre d’indicateurs est limité (effectifs ou proportion, cumulées ou non). Il n’y a pas d’option by mais on peut directement croiser les dimensions avec plusieurs variables. Je n’ai jamais utilisé cette commande en dehors de la formation, donc je n’en donnerai que deux exemples:</p>
<div class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="kw">preserve</span> </span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a><span class="kw">contract</span> rep78 foreign </span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a><span class="kw">restore</span></span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a><span class="kw">preserve</span> </span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a><span class="kw">contract</span> rep78 foreign,  <span class="kw">percent</span>(percentage) </span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a><span class="ot">list</span></span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a><span class="kw">restore</span></span></code><button title="Copier vers le presse-papier" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Note: Below code run with echo to enable preserve/restore functionality.)

. preserve

. contract rep78 foreign

. list

     +--------------------------+
     | rep78    foreign   _freq |
     |--------------------------|
  1. |     1   Domestic       2 |
  2. |     2   Domestic       8 |
  3. |     3   Domestic      27 |
  4. |     3    Foreign       3 |
  5. |     4   Domestic       9 |
     |--------------------------|
  6. |     4    Foreign       9 |
  7. |     5   Domestic       2 |
  8. |     5    Foreign       9 |
  9. |     .   Domestic       4 |
 10. |     .    Foreign       1 |
     +--------------------------+

. restore

. preserve

. contract rep78 foreign, percent(percentage)

. list

     +-------------------------------------+
     | rep78    foreign   _freq   percen~e |
     |-------------------------------------|
  1. |     1   Domestic       2       2.70 |
  2. |     2   Domestic       8      10.81 |
  3. |     3   Domestic      27      36.49 |
  4. |     3    Foreign       3       4.05 |
  5. |     4   Domestic       9      12.16 |
     |-------------------------------------|
  6. |     4    Foreign       9      12.16 |
  7. |     5   Domestic       2       2.70 |
  8. |     5    Foreign       9      12.16 |
  9. |     .   Domestic       4       5.41 |
 10. |     .    Foreign       1       1.35 |
     +-------------------------------------+

. restore

. </code></pre>
</div>
</div>


</section>
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>Cela peut être plusieurs bases.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p><strong><code>m:1</code></strong> renvoit un message d’erreur. Dans ce sens, la base active doit être <em>period_act</em> et la base using <em>sexe</em>.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Cela peut être une zône géographique<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>La question des pondérations sera traitée dans le chapitre suivant<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copié");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copié");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./chapitre5.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title"><strong>Les variables</strong></span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./chapitre7.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Analyse statistique avec Stata</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Marc Thévenin / Ined-Sms / Juin 2023</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","selector":".lightbox","loop":true,"openEffect":"zoom","descPosition":"bottom"});</script>



</body></html>